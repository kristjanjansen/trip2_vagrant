#!/bin/bash

if [ $# -eq 0 ]; then
    echo "Usage: ./update.sh local-db-password remote-db-password"
else
    mysqladmin -uroot -p$1 -f drop trip
    mysqladmin -uroot -p$1 create trip
    ssh trip_admin@trip.ee "mysqldump -uroot -p$2 --ignore-table=trip.accesslog --ignore-table=trip.actions --ignore-table=trip.actions_aid --ignore-table=trip.aggregator_category --ignore-table=trip.aggregator_category_feed --ignore-table=trip.aggregator_category_item --ignore-table=trip.aggregator_feed --ignore-table=trip.aggregator_item --ignore-table=trip.authmap --ignore-table=trip.autoassignrole --ignore-table=trip.autoassignrole_page --ignore-table=trip.autoload_registry --ignore-table=trip.autoload_registry_file --ignore-table=trip.backup_migrate_destinations --ignore-table=trip.backup_migrate_profiles --ignore-table=trip.backup_migrate_schedules --ignore-table=trip.batch --ignore-table=trip.blocks --ignore-table=trip.blocks_roles --ignore-table=trip.boost_cache --ignore-table=trip.boost_cache_relationships --ignore-table=trip.boost_cache_settings --ignore-table=trip.boost_crawler --ignore-table=trip.boxes --ignore-table=trip.browscap --ignore-table=trip.browscap_statistics --ignore-table=trip.cache --ignore-table=trip.cache_block --ignore-table=trip.cache_browscap --ignore-table=trip.cache_content --ignore-table=trip.cache_filter --ignore-table=trip.cache_form --ignore-table=trip.cache_menu --ignore-table=trip.cache_mollom --ignore-table=trip.cache_page --ignore-table=trip.cache_path --ignore-table=trip.cache_rules --ignore-table=trip.cache_tax_image --ignore-table=trip.cache_update --ignore-table=trip.cache_views --ignore-table=trip.cache_views_data --ignore-table=trip.context --ignore-table=trip.ctools_css_cache --ignore-table=trip.ctools_object_cache --ignore-table=trip.date_format_locale --ignore-table=trip.date_format_types --ignore-table=trip.date_formats --ignore-table=trip.devel_queries --ignore-table=trip.devel_times --ignore-table=trip.empty_page --ignore-table=trip.fb_app --ignore-table=trip.fb_user --ignore-table=trip.fbconnect_users --ignore-table=trip.filter_formats --ignore-table=trip.filters --ignore-table=trip.flood --ignore-table=trip.history --ignore-table=trip.imagecache_action --ignore-table=trip.imagecache_preset --ignore-table=trip.languages --ignore-table=trip.locales_source --ignore-table=trip.locales_target --ignore-table=trip.menu_custom --ignore-table=trip.menu_links --ignore-table=trip.menu_router --ignore-table=trip.mollom --ignore-table=trip.mollom_form --ignore-table=trip.node_convert_templates --ignore-table=trip.performance_detail --ignore-table=trip.performance_summary --ignore-table=trip.persistent_login --ignore-table=trip.persistent_login_history --ignore-table=trip.phpads_acls --ignore-table=trip.phpads_adclicks --ignore-table=trip.phpads_adstats --ignore-table=trip.phpads_adviews --ignore-table=trip.phpads_affiliates --ignore-table=trip.phpads_banners --ignore-table=trip.phpads_cache --ignore-table=trip.phpads_clients --ignore-table=trip.phpads_config --ignore-table=trip.phpads_images --ignore-table=trip.phpads_session --ignore-table=trip.phpads_targetstats --ignore-table=trip.phpads_userlog --ignore-table=trip.phpads_zones --ignore-table=trip.poll --ignore-table=trip.poll_choices --ignore-table=trip.quiz_long_answer_node_properties --ignore-table=trip.quiz_long_answer_user_answers --ignore-table=trip.quiz_matching_node --ignore-table=trip.quiz_matching_user_answers --ignore-table=trip.quiz_multichoice_answers --ignore-table=trip.quiz_multichoice_properties --ignore-table=trip.quiz_multichoice_user_answer_multi --ignore-table=trip.quiz_multichoice_user_answers --ignore-table=trip.quiz_multichoice_user_settings --ignore-table=trip.quiz_node_properties --ignore-table=trip.quiz_node_relationship --ignore-table=trip.quiz_node_result_options --ignore-table=trip.quiz_node_results --ignore-table=trip.quiz_node_results_answers --ignore-table=trip.quiz_question_latest_quizzes --ignore-table=trip.quiz_question_properties --ignore-table=trip.quiz_scale_answer --ignore-table=trip.quiz_scale_answer_collection --ignore-table=trip.quiz_scale_node_properties --ignore-table=trip.quiz_scale_user --ignore-table=trip.quiz_scale_user_answers --ignore-table=trip.quiz_short_answer_node_properties --ignore-table=trip.quiz_short_answer_user_answers --ignore-table=trip.quiz_terms --ignore-table=trip.quiz_truefalse_node --ignore-table=trip.quiz_truefalse_user_answers --ignore-table=trip.quiz_user_settings --ignore-table=trip.rules_rules --ignore-table=trip.rules_scheduler --ignore-table=trip.rules_sets --ignore-table=trip.search_dataset --ignore-table=trip.search_index --ignore-table=trip.search_node_links --ignore-table=trip.search_total --ignore-table=trip.semaphore --ignore-table=trip.sessions --ignore-table=trip.system --ignore-table=trip.trigger_assignments --ignore-table=trip.variable --ignore-table=trip.views_display --ignore-table=trip.views_object_cache --ignore-table=trip.views_view --ignore-table=trip.wysiwyg --ignore-table=trip.wysiwyg_user trip | gzip > trip.sql.gz"
    scp trip_admin@trip.ee:/home/trip_admin/trip.sql.gz .
    gunzip -c trip.sql.gz | mysql -uroot -p$1 trip
    rm trip.sql.gz
    cd trip2
    php artisan migrate:refresh
    php artisan convert:all
fi